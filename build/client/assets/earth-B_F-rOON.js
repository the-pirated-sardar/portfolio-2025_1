import{r as e,j as E}from"./jsx-runtime-BMrMXMSG.js";import{m as je,a as ze,b as Me,c as Ne,d as Fe,e as Oe,f as De,g as Ve}from"./milkyway-CE79tktm.js";import{b as He,u as Ye,T as We,L as Xe,t as Ze}from"./image-cK7Yol7S.js";import{S as Ge}from"./section-WIR9c-n7.js";import{u as qe}from"./useWindowSize-DlOz3mXe.js";import{V as ue,W as Be,S as Ce,A as Ie,P as Je,a as Ue,b as $e,R as Ke,c as Qe,d as et,O as tt,H as nt,e as rt,f as st,g as ct,L as at,E as ot,h as it,i as ut}from"./three-CjGFJPVA.js";import{c as Ee}from"./clamp-e7DugykH.js";import{b as Re,d as lt,c as ke,m as dt}from"./style-CdyozSHa.js";import{r as ft,c as mt,a as pt,g as le,t as ht,m as gt}from"./three-f4FSUuQw.js";import{t as bt}from"./throttle-BgiUmwhn.js";import{u as P}from"./use-spring-2oVTzKD3.js";import"./components-Dta19ZtI.js";import"./index-C7rQJm6-.js";const wt="_earth_1awhs_1",xt="_loader_1awhs_8",vt="_viewport_1awhs_22",St="_canvas_1awhs_33",yt="_labels_1awhs_52",Ct="_label_1awhs_52",Et="_vignette_1awhs_82",Rt="_sections_1awhs_94",Lt="_section_1awhs_94",R={earth:wt,loader:xt,viewport:vt,canvas:St,labels:yt,label:Ct,vignette:Et,sections:Rt,section:Lt},he={x:0,y:0,z:2},de=(n,u,h)=>n+h*(u-n),Le=n=>Object.keys(n).map(u=>parseFloat(Math.round(n[u]*100)/100).toFixed(2)).join(", "),fe=n=>!n||!n.camera?he:{x:n.camera[0],y:n.camera[1],z:n.camera[2]},kt=(n,u)=>{const h=(j=0)=>Math.round((j+Number.EPSILON)*100)/100;return h(n==null?void 0:n.x)===h(u==null?void 0:u.x)&&h(n==null?void 0:n.y)===h(u==null?void 0:u.y)&&h(n==null?void 0:n.z)===h(u==null?void 0:u.z)},me={stiffness:80,damping:40,mass:2,restSpeed:.001,restDelta:.001},pe={stiffness:40,damping:30,mass:2,restSpeed:.001,restDelta:.001},_t={stiffness:40,damping:30},_e=e.createContext({}),Wt=({position:n=[0,0,0],scale:u=1,hideMeshes:h=[],labels:j=[],className:Z,children:G})=>{const[m,q]=e.useState(!1),[z,F]=e.useState(!1),[B,Q]=e.useState(!1),[I,Ae]=e.useState(!1),g=e.useRef([]),ee=e.useRef(),te=e.useRef(),O=e.useRef(),A=e.useRef(),S=e.useRef(),o=e.useRef(),ge=e.useRef(),be=e.useRef(),ne=e.useRef(),p=e.useRef(),J=e.useRef(),D=e.useRef(),M=He(O),U=e.useRef(),re=e.useRef(fe(g.current[0])),$=e.useRef([]),y=e.useRef(),se=e.useRef(),we=e.useRef(),ce=e.useRef(),{width:V,height:ae}=qe(),K=Ye(),L=P(0,me),k=P(0,me),_=P(0,me),H=P(0,pe),Y=P(0,pe),W=P(0,pe),N=P(0,_t),oe=e.useCallback(()=>{if(!M){cancelAnimationFrame(U.current);return}U.current=requestAnimationFrame(oe);const r=ge.current.getDelta();D.current.update(r),y.current.update(),S.current.render(A.current,o.current),$.current.forEach(c=>{const{element:i,position:b,sprite:x}=c,d=new ue(...b),a=o.current.position.distanceTo(p.current.position),f=o.current.position.distanceTo(x.position)>a;d.project(o.current),d.x=Math.round((.5+d.x/2)*window.innerWidth),d.y=Math.round((.5-d.y/2)*window.innerHeight),i.style.setProperty("--posX",Re(d.x)),i.style.setProperty("--posY",Re(d.y)),f?i.dataset.occluded=!0:i.dataset.occluded=!1})},[M]);e.useEffect(()=>{ce.current=!0;const{innerWidth:r,innerHeight:c}=window;S.current=new Be({canvas:O.current,antialias:!1,alpha:!0,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0}),S.current.setPixelRatio(1),S.current.outputColorSpace=Ce,S.current.toneMapping=Ie,o.current=new Je(54,r/c,.1,100),o.current.position.x=re.current.x,o.current.position.y=re.current.y,o.current.position.z=re.current.z,o.current.lookAt(0,0,0),L.set(o.current.position.x,!1),k.set(o.current.position.y,!1),_.set(o.current.position.z,!1),A.current=new Ue,ge.current=new $e,ne.current=new Ke;const i=new Qe(2236962,.05),b=new et(16777215,1.5);b.position.set(3,0,1);const x=[i,b];return x.forEach(d=>A.current.add(d)),y.current=new tt(o.current,O.current),y.current.enableZoom=!1,y.current.enablePan=!1,y.current.enableDamping=!1,y.current.rotateSpeed=.5,()=>{ce.current=!1,cancelAnimationFrame(U.current),ft(x),mt(A.current),pt(S.current)}},[]),e.useEffect(()=>{const r=()=>{F(!0),L.stop(),k.stop(),_.stop()},c=()=>{L.set(o.current.position.x,!1),k.set(o.current.position.y,!1),_.set(o.current.position.z,!1),F(!1)};return y.current.addEventListener("start",r),y.current.addEventListener("end",c),()=>{y.current.removeEventListener("start",r),y.current.removeEventListener("end",c)}},[L,k,_]),e.useEffect(()=>{if(!m)return;const r=le("Chunk",p.current),c=le("Atmosphere",p.current),i=(t,l)=>{o.current.position[t]=l},b=L.on("change",t=>i("x",t)),x=k.on("change",t=>i("y",t)),d=_.on("change",t=>i("z",t)),a=(t,l)=>{r.position[t]=l},T=H.on("change",t=>a("x",t)),f=Y.on("change",t=>a("y",t)),w=W.on("change",t=>a("z",t)),s=N.on("change",t=>{c.material.opacity=t});return()=>{b(),x(),d(),T(),f(),w(),s()}},[L,k,_,H,Y,W,m,N]),e.useEffect(()=>{V<=lt.tablet&&(y.current.enabled=!1)},[V]),e.useEffect(()=>{if(m)return;const r=new nt,c=new rt(S.current);c.compileCubemapShader();const i=async()=>{const a=await gt.loadAsync(Ve);p.current=a.scene,J.current=a.animations,D.current=new ut(p.current),D.current.timeScale=.1,p.current.traverse(async T=>{const{material:f,name:w}=T;w==="Atmosphere"&&(f.alphaMap=f.map),f&&await S.current.initTexture(f)}),p.current.position.x=n[0],p.current.position.y=n[1],p.current.position.z=n[2],p.current.scale.x=u,p.current.scale.y=u,p.current.scale.z=u},b=async()=>{const a=await r.loadAsync([ze,Me,Ne,Fe,Oe,De]);a.magFilter=it,se.current=c.fromCubemap(a),c.dispose(),await S.current.initTexture(se.current.texture)},x=async()=>{const a=await ht.loadAsync(je);a.mapping=ot,a.colorSpace=Ce,A.current.background=a,await S.current.initTexture(a)},d=async()=>{await Promise.all([x(),b(),i()]),p.current.traverse(({material:a})=>{a&&(a.envMap=se.current.texture,a.needsUpdate=!0)}),ce.current&&q(!0)};e.startTransition(()=>{d(),setTimeout(()=>{Ae(!0)},1e3)})},[m,n,u]),e.useEffect(()=>(m&&!we.current&&(A.current.add(p.current),we.current=!0),m&&M&&(Q(!0),oe()),()=>{cancelAnimationFrame(U.current)}),[oe,M,m]),e.useEffect(()=>{m&&(te.current.innerHTML="",$.current=j.map(r=>{const c=document.createElement("div");c.classList.add(R.label),c.dataset.hidden=!0,c.style.setProperty("--delay",`${r.delay||0}ms`),c.textContent=r.text,te.current.appendChild(c);const i=new st;return i.position.set(...r.position),i.scale.set(60,60,1),{element:c,...r,sprite:i}}))},[j,m]),e.useEffect(()=>{S.current.setSize(V,ae),o.current.aspect=V/ae,o.current.updateProjectionMatrix()},[V,ae]),e.useEffect(()=>{const r=O.current,c=i=>{const{innerWidth:b,innerHeight:x}=window,d=Le(o.current.position);console.info({cameraPosition:d}),be.current=new ct(i.clientX/b*2-1,-(i.clientY/x)*2+1),ne.current.setFromCamera(be.current,o.current);const a=ne.current.intersectObjects(A.current.children,!0);if(a.length>0){const T=Le(a[0].point);console.info({clickPosition:T})}};return()=>{r.removeEventListener("click",c)}},[]);const xe=e.useCallback(()=>{if(!ee.current)return;const{offsetTop:r}=ee.current,{innerHeight:c}=window,i=window.scrollY-r;let b;const x=f=>{const w=g.current[f].meshes;p.current.traverse(s=>{const{name:t}=s,l=le("Chunk",p.current),v=w==null?void 0:w.includes(t),X=h==null?void 0:h.includes(t);if(v)if(t==="Atmosphere")s.visible=!0,N.set(1);else if(t==="Chunk"){const C=new ue(-.4,.4,.4);s.visible=!0,K?s.position.set(...C.toArray()):(H.set(C.x),Y.set(C.y),W.set(C.z))}else t==="EarthFull"&&l.visible?s.visible=!1:s.visible=!0;else if(X&&!v)if(t==="Atmosphere")N.set(0);else if(t==="Chunk"){const C=new ue(0,0,0);kt(C,l.position)&&(s.visible=!1),H.set(C.x),Y.set(C.y),W.set(C.z)}else t==="EarthPartial"&&l.visible?s.visible=!0:s.visible=!1})},d=f=>{const w=g.current[f].animations;K||(J.current.forEach((s,t)=>{w.find(l=>l.includes(t.toString()))||D.current.clipAction(s).reset().stop()}),J.current.length&&g.current[f].animations&&w.forEach(s=>{const t=s.split(":"),l=J.current[Number(t[0])],v=D.current.clipAction(l);(!t[1]||t[1]!=="loop")&&(v.clampWhenFinished=!0,v.loop=at),v.play()}))},a=f=>{$.current.forEach(s=>{s.hidden&&(s.element.dataset.hidden=!0,s.element.setAttribute("aria-hidden",!0))}),g.current[f].labels.forEach(s=>{$.current.filter(l=>l.text===s).forEach(l=>{l.element.dataset.hidden=!1,l.element.setAttribute("aria-hidden",!1)})})};requestAnimationFrame(()=>{const f=g.current.length-1,w=Math.floor(i/c),s=Ee(w,0,f),t=g.current[s],l=g.current[s+1],v=fe(t)||he,X=fe(l)||he,C=(i-c*s)/c,ie=Ee(C,0,1),ve=de(v.x,X.x,ie),Se=de(v.y,X.y,ie),ye=de(v.z,X.z,ie);if(b!==v&&g.current.length&&t&&(x(s),d(s),a(s)),b=v,!z){if(K){o.current.position.set(ve,Se,ye);return}L.set(ve),k.set(Se),_.set(ye)}})},[L,k,_,H,Y,W,z,h,N,K]);e.useEffect(()=>{const r=bt(xe,100);return m&&M&&window.addEventListener("scroll",r),()=>{window.removeEventListener("scroll",r)}},[xe,M,m,N]);const Te=e.useCallback(r=>{g.current=[...g.current,r]},[]),Pe=e.useCallback(r=>{g.current=g.current.filter(c=>c!==r)},[]);return E.jsx(_e.Provider,{value:{registerSection:Te,unregisterSection:Pe},children:E.jsxs("div",{className:ke(R.earth,Z),ref:ee,children:[E.jsxs("div",{className:R.viewport,children:[E.jsx("canvas",{className:R.canvas,"data-visible":m&&B,"data-grabbing":z,ref:O}),E.jsx("div",{className:R.labels,"aria-live":"polite",ref:te}),E.jsx("div",{className:R.vignette})]}),E.jsx("div",{className:R.sections,children:G}),E.jsx(We,{unmount:!0,in:!m&&I,timeout:dt(Ze.base.durationL),children:r=>E.jsx(Ge,{className:R.loader,"data-visible":r,children:E.jsx(Xe,{})})})]})})},Xt=e.memo(({children:n,scrim:u,scrimReverse:h,className:j,camera:Z=[0,0,0],animations:G=[],meshes:m=[],labels:q=[]})=>{const{registerSection:z,unregisterSection:F}=e.useContext(_e),B=e.useRef(),Q=JSON.stringify(G)+JSON.stringify(Z)+JSON.stringify(q)+JSON.stringify(m);return e.useEffect(()=>{const I={camera:Z,animations:G,meshes:m,labels:q,sectionRef:B};return z(I),()=>{F(I)}},[Q,z,F]),E.jsx("div",{className:ke(R.section,j),"data-scrim":u,"data-scrim-reverse":h,ref:B,children:n})});export{Wt as Earth,Xt as EarthSection};
